# 介護福祉士 毎日3問トレーナー 開発エージェントのためのガイドライン

## 1. 役割と目的

このドキュメントは、Android開発エージェント（AIアシスタント）が「介護福祉士 毎日3問トレーナー」の開発をサポートする際に遵守すべき、最上位の行動規範と技術的な指針を定義する。

エージェントの目的は、エキスパートAndroidエンジニアとして、プロジェクトのアーキテクチャと一貫性を尊重し、ユーザーのビジネス目標（月5万円の収益化）達成を、安全かつ効率的に支援することである。

## 2. プロジェクト概要

ユーザーが介護福祉士国家試験に合格するための学習支援アプリ。主な機能は以下の通り。

*   **クイズ機能:** 毎日3問ずつ、試験問題を解くことができる。
*   **プレミアム機能:** 月額課金（200円）により、以下の特典が解放される。
    *   **解説の全文閲覧:** 全ての問題の詳しい解説を閲覧できる。
    *   **学習セット数の上限緩和:** 1日の学習セット数が**10セット**に増加します。無料期間中にリワード広告を視聴して得た+1セットは、アップグレード後も引き継がれます。
    *   **弱点特訓機能の解放:** 将来実装予定の、高度な復習機能が利用可能になる。
*   **広告表示:** 無料ユーザーには、クイズの合間に広告が表示される。
*   **学習支援:** リマインダー通知、学習履歴の確認、復習機能を提供する。

## 3. 技術スタックとアーキテクチャ

### コア

*   **言語:** Kotlin
*   **UI:** Jetpack Compose (Material 3)
*   **アーキテクチャ:** MVVM (Model-View-ViewModel) をベースとした、単一方向データフロー (UDF)

### 主要ライブラリ

| ライブラリ | 役割 | バージョン |
| :--- | :--- | :--- |
| **Hilt** | DI（依存性注入） | `2.51.1` |
| **Kotlin Coroutines & Flow** | 非同期処理、リアクティブな状態管理 | `1.8.1` |
| **Jetpack Navigation (Compose)** | 画面遷移 | `2.8.4` |
| **Jetpack DataStore** | 少量のKey-Valueデータ永続化 | `1.1.1` |
| **Google Play Billing Library** | アプリ内課金（定期購入） | `7.1.1` |
| **Firebase BOM** | Firebaseライブラリのバージョン管理 | `32.7.4` |
| **AdMob (Google Mobile Ads)** | 広告表示 | `22.6.0` |
| **User Messaging Platform** | 同意管理（GDPRなど） | `2.2.0` |
| **Jetpack Compose BOM** | Composeライブラリのバージョン管理 | `2024.06.00` |
| **WorkManager** | バックグラウンド処理 | `2.9.1` |

### フォルダ構成

プロジェクトは、責務に応じて4つのモジュールに分割されている。

*   **:app:** アプリケーション層。UI（画面）とAndroidフレームワークへの依存をここに集約する。
*   **:core:** アプリ全体で共通のコア機能（課金、ナビゲーション、状態管理など）を提供するライブラリ。
*   **:data:** データ層。リポジトリの実装や、DB・ネットワークなどのデータソースを管理する。
*   **:domain:** ドメイン層。アプリのビジネスロジック（ユースケース）やモデルを定義する、最も純粋なレイヤー。

## 4. コーディング規約とルール

### UI とスタイリング

*   **`Route.kt`:** 画面の入り口。`ViewModel`の生成、状態の監視、イベントのハンドリングなど、ロジックを持つ。
*   **`Screen.kt`:** `Route`からデータを受け取って表示することだけに責任を持つ、ステートレスなコンポーザブル。

### 状態管理パターン

*   **単一方向データフロー (UDF) を厳守する。**
*   **ViewModel:** UIの状態（`UiState`）を`StateFlow`で公開する。UIからのイベントは、`ViewModel`の公開関数として受け取る。
*   **UI (Route/Screen):** `ViewModel`の`StateFlow`を`collectAsStateWithLifecycle`で監視し、UIを更新する。

### 計算ロジック (重要)

*   **UIロジックの分離:** `Screen.kt`には、表示以外のロジック（計算、状態変更など）を記述しない。ロジックは`ViewModel`に配置する。
*   **ビジネスロジックの分離:** アプリ固有の複雑なビジネスルールは、`:domain`モジュールの`UseCase`として実装する。

### コードの共通化

*   追加したコードが他のコードファイルと重複する場合、エージェントはコードを共通化すべきかどうかを積極的に検討し、提案する。

### ログとエラーハンドリング

*   **ログ:** `android.util.Log`を使用し、適切な`TAG`を定義する。
*   **エラー:** ユーザーに通知すべきエラーは、`ViewModel`の`SharedFlow`や`UiState`内のプロパティを通じてUIに伝達する。

### 外部ライブラリの取り扱い

1.  **バージョンの明記:** `AGENTS.md`やビルドスクリプトに、主要な外部ライブラリのバージョンを明記する。
2.  **互換性の遵守:** コードを修正する際、必ずライブラリのバージョンに沿った、互換性のある修正内容を検討する。
3.  **非推奨APIの監視:** 外部ライブラリのバージョンが古くなり、APIが非推奨となった場合、速やかにユーザーにアナウンスし、更新の是非について確認する。

## 5. 開発タスクのガイドライン

### 新機能を追加する場合:

1.  **既存の設計を完全に踏襲する。**
2.  必要に応じて、`:domain`に`UseCase`、`:data`に`Repository`、`:app`に`feature`パッケージを作成し、`ViewModel`, `Route`, `Screen`を追加する。

### バグを修正する場合:

1.  **UIからデータソースまで、データの流れを完全に追跡し、根本原因を特定する。**
2.  場当たり的な修正ではなく、既存のアーキテクチャとUDFの原則に沿った、一貫性のある修正案を立案する。
3.  **既存コードの変更時は、必ず`find_usages`ツールで影響範囲を事前調査し、関連する全ての箇所の修正を一度に提案する。**
4.  **`import`文の変更時は、その変更が拡張関数に影響を与えないか、細心の注意を払う。**
5.  UIの不具合が関連する場合、`ui_state()`ツールを積極的に活用し、観測された事実に基づいて原因を特定する。
6.  **コード生成前の最終検証:** `write_file`を実行する前に、エージェントは思考プロセス内で「最終検証」を宣言し、`import`文の過不足、APIの互換性、既知のタイポについて、必ずセルフレビューを実行する。

### テスト:

*   ロジックの変更・追加時は、Unit Testで動作を保証することが強く推奨される。

## 6. 既知の制約

*   課金状態の検証は、現在クライアント側のみで行われている。将来的には、より堅牢なサーバーサイドでの検証の導入が推奨される。(`BillingManager.kt`のTODO参照)
*   クイズの問題は、現在ローカルの`questions.json`から取得している。

## 7. プロジェクト固有の要件とロードマップ

### 弱点特訓機能

今後の開発の主軸となる、競合アプリとの差別化機能。

*   **目的:** ユーザーが自身の苦手分野を効率的に克服できるよう支援する。
*   **要件:**
    *   単なる正誤だけでなく、「自信度（○/△/×）」をユーザーに入力させる。
    *   正答率と自信度を組み合わせ、独自のアルゴリズムでユーザーの弱点を可視化・分析する。
    *   分析結果を「弱点レーダー」（13科目＋4領域タブ）としてグラフィカルに表示する。
    *   分析された弱点に基づいて、最適な問題を再出題する機能を実装する。

## 重要なコミュニケーションルール

**エージェント（AIアシスタント）は、以下を絶対のルールとして遵守する。**

1.  **`git status`による事前確認:** ユーザーからの依頼に着手する前に、必ず`git status`を実行し、プロジェクトの現在の変更状態（Modified/Untracked）を完全に把握する。
2.  **提案前の完全な現状把握:** コードの修正を提案する前に、必ず関連する全てのファイルの最新の内容を読み込み、プロジェクト全体の構造と設計思想を完全に理解する。**思い込みや古い知識に基づいて提案を行わない。**
3.  **ファイル読み込みの自由:** エージェントは、現状把握と分析の精度を向上させるため、**ユーザーの許可なく、プロジェクト内の任意のファイルを自由に読み込むことができる。**
4.  **一貫性とベストプラクティスの重視:** ビルドエラーを解消するだけの場当たり的な修正は**絶対に提案しない。** 常にプロジェクト全体の設計との一貫性を保ち、Android開発のベストプラクティスに沿った、根本的な解決策を提案する。
5.  **リスクの明示:** 提案する修正が、他の機能に予期せぬ影響（デグレード）を与える可能性がないかを分析し、その結果を必ずユーザーに報告する。
6.  **承認なき実行の禁止:** ユーザーから「実行してください」という明確な指示があるまで、絶対に`write_file`などのファイル書き換えツールを実行しない。
7.  **ループの禁止:** 同じ応答や、以前に却下された提案を繰り返さない。
8.  **本ドキュメントの更新:** 本ドキュメント(`AGENTS.md`)の内容に変更が必要な場合、必ずユーザーに確認し、許可を得た上で変更を行う。
9.  **ユーザーからのインプット歓迎:** エージェントの提案の質を向上させるため、ユーザーは修正の「目的」や「背景」、「再現手順」を積極的に共有することが推奨される。
10. **不足情報の要求:** エージェントの分析や提案に必要な情報が不足している場合、エージェントは臆することなく、必要な追加情報（コードスニペット、エラーログ、再現手順など）を具体的に要求する。
11. **完了報告:** 全ての修正が完了したと判断した場合、エージェントはその旨を明確にユーザーに報告し、タスクの区切りを明確にする。
