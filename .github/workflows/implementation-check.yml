
name: Implementation Check (PR1â€“PR4)

on:
  push:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # rg (ripgrep) ã‚’ç¢ºå®Ÿã«ä½¿ãˆã‚‹ã‚ˆã†ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install ripgrep
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ripgrep

      - name: Collect findings
        id: check
        run: |
          set -e
          echo "### å®Ÿè£…åæ˜ ãƒã‚§ãƒƒã‚¯ (PRâ‘ ã€œâ‘£)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          pass(){ echo "âœ… $1" >> $GITHUB_STEP_SUMMARY; }
          warn(){ echo "âš ï¸ $1" >> $GITHUB_STEP_SUMMARY; }
          fail(){ echo "âŒ $1" >> $GITHUB_STEP_SUMMARY; echo "$1" >> failures.txt; }

          # ========== PRâ‘  ==========
          echo "#### PRâ‘ ï¼šPBL v7 + Paywall + ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å" >> $GITHUB_STEP_SUMMARY
          grep -E 'namespace\s*=\s*"jp\.msaitoappdev\.caregiver\.humanmed"' app/build.gradle.kts && pass "namespace OK" || fail "namespace ãŒ jp.msaitoappdev.caregiver.humanmed ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
          grep -E 'applicationId\s*=\s*"jp\.msaitoappdev\.caregiver\.humanmed"' app/build.gradle.kts && pass "applicationId OK" || fail "applicationId ãŒ jp.msaitoappdev.caregiver.humanmed ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
          grep -E 'com\.android\.billingclient:billing-ktx:7\.1\.1' app/build.gradle.kts && pass "Billing v7.1.1 OK" || fail "Billing ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ 7.1.1 ã§ã¯ã‚ã‚Šã¾ã›ã‚“"

          if rg -n 'PendingPurchasesParams\.newBuilder\(\).*enableOneTimeProducts\(\)' -S -g '**/BillingManager.kt' >/dev/null; then
            pass "enablePendingPurchases(PendingPurchasesParams.enableOneTimeProducts()) OK"
          else
            fail "BillingClient ã§ enableOneTimeProducts() ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆv7 å¿…é ˆï¼‰"
          fi
          if rg -n 'sub_premium_monthly_200jpy' -S -g '**/BillingConstants.kt' >/dev/null; then pass "å•†å“ID OK"; else fail "å•†å“ID sub_premium_monthly_200jpy ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; fi
          if rg -n 'æœˆé¡ Â¥200 ã§ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆãƒˆãƒ©ã‚¤ã‚¢ãƒ«ãªã—ï¼‰' -S -g '**/PaywallScreen.kt' >/dev/null; then pass "Paywall æ–‡è¨€ OK"; else warn "Paywall æ–‡è¨€ãŒä»•æ§˜ã¨ç•°ãªã‚‹å¯èƒ½æ€§ã‚ã‚Š"; fi

          # ========== PRâ‘¡ ==========
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### PRâ‘¡ï¼šæ¯æ—¥ãƒªãƒã‚¤ãƒ³ãƒ‰é€šçŸ¥ + Android 13 é€šçŸ¥è¨±å¯" >> $GITHUB_STEP_SUMMARY
          rg -n 'androidx\.work:work-runtime-ktx:2\.9\.' -S app/build.gradle.kts >/dev/null && pass "WorkManager 2.9.x OK" || fail "WorkManager ä¾å­˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (2.9.x æ¨å¥¨)"
          for f in DailyReminderWorker.kt ReminderScheduler.kt ReminderNotifier.kt; do
            if rg -n '' -g "**/$f" >/dev/null; then pass "$f ã‚ã‚Š"; else fail "$f ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; fi
          done
          if rg -n 'CHANNEL_ID\s*=\s*"reminder_daily_channel"' -S -g '**/ReminderNotifier.kt' >/dev/null; then pass "é€šçŸ¥ãƒãƒ£ãƒãƒ«ID OK"; else fail "é€šçŸ¥ãƒãƒ£ãƒãƒ«ID (reminder_daily_channel) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; fi
          if rg -n 'setSmallIcon\(R\.drawable\.ic_stat_quiz\)' -S -g '**/ReminderNotifier.kt' >/dev/null; then pass "é€šçŸ¥å°ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç™½ä¸€è‰²ï¼‰OK"; else warn "é€šçŸ¥å°ã‚¢ã‚¤ã‚³ãƒ³ãŒ ic_stat_quiz ã§ã¯ãªã„å¯èƒ½æ€§ã‚ã‚Š"; fi
          grep -q 'android.permission.POST_NOTIFICATIONS' app/src/main/AndroidManifest.xml && pass "POST_NOTIFICATIONS å®£è¨€ OK" || warn "Android 13+ é€šçŸ¥æ¨©é™ã®å®£è¨€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          rg -n '<data android:scheme="caregiver" android:host="reminder"' -S app/src/main/AndroidManifest.xml >/dev/null && pass "Deep Link å—ã‘å–ã‚Š OK" || warn "Deep Link ã® intent-filter ãŒè¦‹ã¤ã‹ã‚‰ãªã„å¯èƒ½æ€§ã‚ã‚Š"

          # ========== PRâ‘¢ ==========
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### PRâ‘¢ï¼šè¨­å®šç”»é¢ï¼ˆON/OFFãƒ»æ™‚åˆ»ãƒ»ç®¡ç†URLãƒ»ãƒãƒªã‚·ãƒ¼ï¼‰" >> $GITHUB_STEP_SUMMARY
          for f in SettingsScreen.kt SettingsViewModel.kt; do
            if rg -n '' -g "**/$f" >/dev/null; then pass "$f ã‚ã‚Š"; else fail "$f ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; fi
          done
          if rg -n 'å®šæœŸè³¼å…¥ã‚’ç®¡ç†' -S -g '**/SettingsScreen.kt' >/dev/null; then pass "å®šæœŸè³¼å…¥ç®¡ç†å°ç·š OK"; else warn "å®šæœŸè³¼å…¥ç®¡ç†ã®æ–‡è¨€ãŒè¦‹ã¤ã‹ã‚‰ãªã„å¯èƒ½æ€§ã‚ã‚Š"; fi
          if rg -n 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼' -S -g '**/SettingsScreen.kt' >/dev/null; then pass "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼å°ç·š OK"; else warn "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼å°ç·šãŒè¦‹ã¤ã‹ã‚‰ãªã„å¯èƒ½æ€§ã‚ã‚Š"; fi

          # ========== PRâ‘£ ==========
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### PRâ‘£ï¼šè³¼å…¥å¾©å…ƒï¼Premiumãƒãƒƒã‚¸ï¼é€šçŸ¥â†’Quizã®DeepLink" >> $GITHUB_STEP_SUMMARY
          if rg -n 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æœ‰åŠ¹|ãƒ•ãƒªãƒ¼' -S -g '**/SettingsScreen.kt' >/dev/null; then pass "Premium ãƒãƒƒã‚¸è¡¨ç¤º OK"; else warn "Premium ãƒãƒƒã‚¸æ–‡è¨€ãŒè¦‹ã¤ã‹ã‚‰ãªã„å¯èƒ½æ€§ã‚ã‚Š"; fi
          if rg -n 'è³¼å…¥ã‚’å¾©å…ƒ' -S -g '**/SettingsScreen.kt' >/dev/null; then pass "è³¼å…¥ã‚’å¾©å…ƒãƒœã‚¿ãƒ³ OK"; else warn "è³¼å…¥ã‚’å¾©å…ƒãƒœã‚¿ãƒ³æ–‡è¨€ãŒè¦‹ã¤ã‹ã‚‰ãªã„å¯èƒ½æ€§ã‚ã‚Š"; fi
          if rg -n 'refreshFromBilling\(\)' -S -g '**/SettingsViewModel.kt' >/dev/null; then pass "refreshFromBilling() å‘¼ã³å‡ºã— OK"; else warn "SettingsViewModel ã‹ã‚‰ refreshFromBilling() å‘¼ã³å‡ºã—ãŒè¦‹å½“ãŸã‚Šã¾ã›ã‚“"; fi
          if rg -n 'deepLinks\s*=\s*listOf\(navDeepLink\s*\{\s*uriPattern\s*=\s*"caregiver://reminder"' -S -g '**/MainActivity.kt' >/dev/null; then pass "é€šçŸ¥â†’Quiz DeepLink OK"; else warn "DeepLink (caregiver://reminder â†’ quiz) ã®å®šç¾©ãŒè¦‹å½“ãŸã‚Šã¾ã›ã‚“"; fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f failures.txt ]; then
            echo "â—ä¸è¶³ã‚ã‚Šï¼šä¸Šè¨˜ âŒ ã‚’ã”ç¢ºèªãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "ğŸ‰ ä¸»è¦è¦³ç‚¹ã¯åæ˜ æ¸ˆã¿ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: (Optional) Upload failure list
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: implementation-check-failures
          path: failures.txt
